<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Karaok√™ Coopers - Vers√£o Oficial</title>
    
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.5.1/dist/confetti.browser.min.js"></script>

    <style>
        /* --- VARI√ÅVEIS DE CORES E ESTILO --- */
        :root { 
            --primary: #0077b6; 
            --bg: #000000;
            --warning: #ffb703;
            --danger: #ff0000;
            --gold: #ffca3a;
            --success: #2ecc71;
            --my-row: rgba(0, 119, 182, 0.2); /* Cor de destaque para sua m√∫sica na fila */
        }

        /* --- RESET E BASE --- */
        body { 
            font-family: 'Segoe UI', Roboto, Helvetica, Arial, sans-serif; 
            background: var(--bg); 
            margin: 0; 
            padding: 10px; 
            text-align: center; 
            color: white; 
            overflow-x: hidden;
        }
        
        /* --- CONTAINER PRINCIPAL --- */
        .container { 
            max-width: 500px; 
            margin: auto; 
            background: url('unnamed.jpg') no-repeat center center;
            background-size: cover; 
            padding: 20px; 
            border-radius: 25px; 
            box-shadow: 0 15px 35px rgba(0,0,0,0.7); 
            min-height: 700px; 
            position: relative; 
            overflow: hidden; 
            display: flex; 
            flex-direction: column; 
        }

        .container::before { 
            content: ""; 
            position: absolute; 
            top: 0; 
            left: 0; 
            width: 100%; 
            height: 100%; 
            background: rgba(0, 0, 0, 0.55); 
            border-radius: 25px; 
            z-index: 0; 
        }

        .content-wrapper { 
            position: relative; 
            z-index: 1; 
            flex-grow: 1; 
            display: flex;
            flex-direction: column;
        }

        /* --- MODAL DE BOAS-VINDAS --- */
        #welcome-modal {
            position: fixed; 
            top: 0; 
            left: 0; 
            width: 100%; 
            height: 100%;
            background: rgba(0,0,0,0.92); 
            z-index: 2000;
            display: none; 
            align-items: center; 
            justify-content: center; 
            padding: 20px;
            backdrop-filter: blur(5px);
        }

        .modal-content {
            background: #111; 
            border: 2px solid var(--primary); 
            padding: 30px;
            border-radius: 25px; 
            max-width: 400px; 
            text-align: center;
            box-shadow: 0 0 30px var(--primary);
        }

        .modal-content h3 { color: var(--gold); margin-top: 0; font-size: 1.5em; }
        .modal-content p { font-size: 15px; line-height: 1.7; color: #ddd; text-align: left; margin-bottom: 20px; }

        .btn-ok { 
            background: var(--primary); 
            color: white; 
            border: none; 
            padding: 15px 35px; 
            border-radius: 15px; 
            font-weight: bold; 
            cursor: pointer; 
            width: 100%; 
            font-size: 16px;
            transition: 0.3s;
        }

        /* --- CABE√áALHO E IDIOMAS --- */
        .header-content { 
            display: flex; 
            align-items: center; 
            justify-content: center; 
            gap: 12px; 
            margin-bottom: 15px; 
        }

        .logo-img { 
            max-width: 65px; 
            height: auto; 
            border-radius: 12px; 
            box-shadow: 0 4px 8px rgba(0,0,0,0.3);
        }

        #app-title { 
            margin: 0; 
            font-size: 1.7em; 
            text-shadow: 2px 2px 5px #000; 
            font-weight: 800;
        }
        
        .lang-bar { 
            display: flex; 
            justify-content: center; 
            gap: 15px; 
            margin-bottom: 20px; 
            padding: 12px; 
            background: rgba(255,255,255,0.08); 
            border-radius: 18px; 
        }

        .lang-item { 
            width: 42px; 
            height: 28px; 
            cursor: pointer; 
            filter: grayscale(100%); 
            opacity: 0.4; 
            transition: 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275); 
            border-radius: 5px; 
            border: 2px solid transparent; 
        }

        .lang-item.active { 
            filter: grayscale(0%); 
            opacity: 1; 
            transform: scale(1.25); 
            border-color: white; 
            box-shadow: 0 0 15px rgba(255,255,255,0.4); 
        }

        /* --- TABELA DE FILA DIN√ÇMICA --- */
        #status-bloqueio { 
            display: none; 
            background: var(--danger); 
            color: white; 
            padding: 12px; 
            border-radius: 12px; 
            margin-bottom: 12px; 
            font-weight: bold; 
            font-size: 14px; 
            border: 2px solid white; 
        }

        .dj-panel { 
            display: none; 
            background: rgba(255,255,255,0.15); 
            padding: 12px; 
            border-radius: 15px; 
            margin-bottom: 15px; 
            justify-content: center; 
        }

        .queue-table { 
            width: 100%; 
            border-collapse: collapse; 
            font-size: 12px; 
            background: rgba(255,255,255,0.95); 
            color: #222; 
            border-radius: 18px; 
            overflow: hidden; 
            margin-top: 10px; 
            box-shadow: 0 8px 20px rgba(0,0,0,0.4);
        }

        .queue-table th, .queue-table td { 
            padding: 12px 10px; 
            border-bottom: 1px solid #eee; 
            text-align: left; 
        }

        .queue-table th { 
            background: #e9ecef; 
            font-weight: 700; 
            color: #444; 
            text-transform: uppercase;
            font-size: 11px;
        }
        
        /* Destaque para a linha do usu√°rio logado */
        .row-user { 
            background-color: var(--my-row) !important; 
            border-left: 5px solid var(--primary);
        }

        .token-badge { 
            background: var(--primary); 
            color: white; 
            padding: 3px 8px; 
            border-radius: 6px; 
            font-size: 10px; 
            display: inline-block; 
            margin-top: 5px; 
            font-weight: bold;
            letter-spacing: 1px;
        }

        .btn-action { 
            border: none; 
            padding: 8px; 
            border-radius: 8px; 
            cursor: pointer; 
            font-weight: bold; 
            transition: 0.2s;
        }

        .btn-cancel { background: var(--danger); color: white; }
        .btn-cancel:hover { background: #b30000; }

        /* --- CAMPO DE BUSCA --- */
        input[type="text"] { 
            width: 100%; 
            padding: 18px; 
            border: none; 
            border-radius: 18px; 
            font-size: 16px; 
            margin-top: 20px; 
            background: rgba(255,255,255,0.92); 
            outline: none; 
            box-sizing: border-box; 
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
            transition: 0.3s;
        }

        input[type="text"]:focus {
            box-shadow: 0 0 15px var(--primary);
            background: #ffffff;
        }

        /* --- RESULTADOS DA BUSCA --- */
        .song-item { 
            background: white; 
            color: #333; 
            padding: 16px; 
            margin: 10px 0; 
            border-radius: 15px; 
            cursor: pointer; 
            text-align: left; 
            border-left: 6px solid var(--primary); 
            transition: 0.2s;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .song-item:active { transform: scale(0.96); background: #f8f9fa; }

        /* --- AVISO DE COPYRIGHT (NEON PULSANTE) --- */
        #copyright-alert {
            background: rgba(255, 0, 0, 0.85); 
            border: 2px solid #ff0000; 
            color: #ffffff;
            padding: 15px; 
            border-radius: 18px; 
            font-size: 13px; 
            margin: 15px 0; 
            display: none; 
            align-items: center; 
            gap: 12px;
            font-weight: bold;
            box-shadow: 0 0 15px rgba(255, 0, 0, 0.5);
            animation: pulse-alert 1.5s infinite;
        }

        @keyframes pulse-alert { 
            0%, 100% { transform: scale(1); opacity: 1; } 
            50% { transform: scale(1.03); opacity: 0.8; } 
        }

        /* --- BOT√ÉO DE ACESSO DJ --- */
        .dj-access-btn { 
            margin-top: 30px; 
            font-size: 11px; 
            opacity: 0.4; 
            background: none; 
            border: 1px solid white; 
            color: white; 
            border-radius: 8px; 
            cursor: pointer; 
            padding: 6px 12px; 
            transition: 0.3s;
        }

        .dj-access-btn:hover { opacity: 1; background: rgba(255,255,255,0.1); }
    </style>
</head>
<body>

    <div id="welcome-modal">
        <div class="modal-content">
            <h3 id="modal-title"></h3>
            <p id="modal-text"></p>
            <button class="btn-ok" onclick="closeWelcome()"></button>
        </div>
    </div>

    <iframe name="hidden_iframe" id="hidden_iframe" style="display:none;"></iframe>

    <div class="container">
        <div class="content-wrapper">
            
            <div class="header-content">
                <img src="9d8daa_198ec12882054dceb6d49d760eba30f0~mv2.jpg" class="logo-img" alt="Logo Coopers">
                <h2 id="app-title">üé§ Karaok√™ Coopers</h2>
            </div>
            
            <div class="lang-bar">
                <img src="portugal-e-brasil-real√ßam-duas-bandeiras-juntas-d-ilustra√ß√£o-283267433.webp" class="lang-item active" onclick="setLang('pt')" id="flag-pt">
                <img src="usa-flag-stars-stripes-uk-260nw-2630619109.webp" class="lang-item" onclick="setLang('en')" id="flag-en">
                <img src="bandeira-da-espanha-balancando-ao-vento_2227-2338.avif" class="lang-item" onclick="setLang('es')" id="flag-es">
                <img src="34921756-nacional-bandeira-do-franca-3d-ilustracao-vetor.jpg" class="lang-item" onclick="setLang('fr')" id="flag-fr">
            </div>

            <div id="status-bloqueio">üõë ENTRADA DE M√öSICAS FECHADA</div>
            
            <div class="dj-panel" id="dj-panel">
                <button style="background:var(--gold); border:none; padding:12px; border-radius:10px; font-weight:bold; cursor:pointer;" id="btn-lock-toggle" onclick="toggleLock()">üîí Bloquear Pedidos</button>
            </div>

            <div id="queueSection">
                <h4 id="txt-fila-label" style="text-align: left; font-size: 14px; margin-bottom: 8px; color: #ccc;">Acompanhe sua vez:</h4>
                <table class="queue-table">
                    <thead>
                        <tr>
                            <th style="width: 35px;">Pos</th>
                            <th id="th-musica">M√∫sica / Artista</th>
                            <th id="th-acao-label" style="width: 50px;">A√ß√£o</th>
                        </tr>
                    </thead>
                    <tbody id="queueBody">
                        </tbody>
                </table>
            </div>

            <input type="text" id="searchInput" oninput="searchSongs()" placeholder="PESQUISE M√öSICA OU ARTISTA">
            
            <div id="copyright-alert">
                <span style="font-size:20px;">‚ö†Ô∏è</span>
                <span id="msg-copyright"></span>
            </div>

            <div id="results"></div>

            <button class="dj-access-btn" onclick="loginDJ()">Acesso DJ</button>

        </div>

        <form id="karaokeForm" action="https://docs.google.com/forms/d/e/1FAIpQLSc2M4LQqNDD79g0o46ImqkwAL6g7EYn74cvxIa2K-6prNBLrQ/formResponse" method="POST" target="hidden_iframe" style="display:none;">
            <input type="hidden" name="entry.1995948109" id="f_hora">
            <input type="hidden" name="entry.105234855" id="f_codigo">
            <input type="hidden" name="entry.1830320650" id="f_musica">
            <input type="hidden" name="entry.730937896" id="f_artista">
            <input type="hidden" name="entry.1210617554" id="f_senha">
        </form>

    </div>

    <script>
        /* --- CONFIGURA√á√ïES DE LINKS --- */
        const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbzShpP_FtohDCryS3EuBxyClFl4AEpc0S2typDFx3mO8M_O5u9Ni2jrtr2L3qrjGgDm/exec"; 
        const SHEET_CSV = "https://docs.google.com/spreadsheets/d/1jL19NPfxuPziBqoVYU8DIPxUtbiqBbKNPgfsyFCIppc/export?format=csv&gid=1924484966";
        
        let isDJ = false;
        let isLocked = (localStorage.getItem('karaokeLocked') === 'true');
        let catalog = [];
        let currentLang = 'pt';

        /* --- DICION√ÅRIO MULTILINGUE --- */
        const translations = {
            pt: { 
                title: "Karaok√™ Coopers", busca: "PESQUISE M√öSICA OU ARTISTA", filaLabel: "Sua posi√ß√£o na Fila:", thMusica: "M√∫sica / Artista", thAcao: "A√ß√£o", tokenLabel: "SENHA:", filaVazia: "Fila vazia!", copyright: "M√∫sica n√£o encontrada. Algumas m√∫sicas n√£o aparecem por direitos autorais.", cancelPrompt: "Deseja cancelar seu pedido?", 
                closed: "Pedidos encerrados!", welcomeT: "Bem-vindo!", welcomeM: "1. Busque sua m√∫sica.<br>2. Pe√ßa clicando nela.<br>3. Sua <b>Senha</b> aparecer√° na tabela da fila!<br>4. Aguarde ser chamado.", btnOk: "VAMOS L√Å!" 
            },
            en: { 
                title: "Coopers Karaoke", busca: "SEARCH SONG OR ARTIST", filaLabel: "Queue Position:", thMusica: "Song / Artist", thAcao: "Action", tokenLabel: "CODE:", filaVazia: "Queue is empty!", copyright: "Song not found due to copyright restrictions.", cancelPrompt: "Cancel your request?", 
                closed: "Orders closed!", welcomeT: "Welcome!", welcomeM: "1. Search for a song.<br>2. Click to request.<br>3. Your <b>Code</b> will show in the queue table!<br>4. Wait for your turn.", btnOk: "LET'S GO!"
            },
            es: { 
                title: "Karaoke Coopers", busca: "BUSCAR M√öSICA", filaLabel: "Tu posici√≥n:", thMusica: "M√∫sica / Artista", thAcao: "Acci√≥n", tokenLabel: "C√ìDIGO:", filaVazia: "¬°Lista vac√≠a!", copyright: "No encontrada por derechos de autor.", cancelPrompt: "¬øCancelar pedido?", 
                closed: "¬°Cerrado!", welcomeT: "¬°Bienvenido!", welcomeM: "1. Busca tu canci√≥n.<br>2. Pide haciendo clic.<br>3. ¬°Tu <b>C√≥digo</b> aparecer√° en la lista!<br>4. Espera tu turno.", btnOk: "¬°VAMOS!"
            },
            fr: { 
                title: "Karaok√© Coopers", busca: "RECHERCHER", filaLabel: "Votre position:", thMusica: "Chanson / Artiste", thAcao: "Action", tokenLabel: "CODE:", filaVazia: "File vide!", copyright: "Non trouv√©e (droits d'auteur).", cancelPrompt: "Annuler?", 
                closed: "Ferm√©!", welcomeT: "Bienvenue!", welcomeM: "1. Cherchez une chanson.<br>2. Cliquez pour commander.<br>3. Votre <b>Code</b> sera dans la file!<br>4. Attendez votre tour.", btnOk: "C'EST PARTI!"
            }
        };

        /* --- CARREGAMENTO INICIAL --- */
        window.onload = () => {
            setLang('pt');
            // Carrega cat√°logo
            fetch('karafuncatalog.csv').then(r => r.text()).then(data => {
                catalog = data.split('\n').map(line => line.replace(/"/g, '').split(/[;,]/));
            });
            // Atualiza√ß√£o da fila
            setInterval(loadQueue, 10000);
            if(isLocked) document.getElementById('status-bloqueio').style.display = 'block';
            if(!localStorage.getItem('hasVisited')) showWelcome();
        };

        function showWelcome() {
            const t = translations[currentLang];
            document.getElementById('modal-title').innerText = t.welcomeT;
            document.getElementById('modal-text').innerHTML = t.welcomeM;
            document.querySelector('.btn-ok').innerText = t.btnOk;
            document.getElementById('welcome-modal').style.display = 'flex';
        }

        function closeWelcome() {
            document.getElementById('welcome-modal').style.display = 'none';
            localStorage.setItem('hasVisited', 'true');
        }

        function setLang(lang) {
            currentLang = lang;
            document.querySelectorAll('.lang-item').forEach(img => img.classList.remove('active'));
            document.getElementById('flag-' + lang).classList.add('active');
            
            const t = translations[lang];
            document.getElementById('app-title').innerText = t.title;
            document.getElementById('searchInput').placeholder = t.busca;
            document.getElementById('msg-copyright').innerText = t.copyright;
            document.getElementById('txt-fila-label').innerText = t.filaLabel;
            document.getElementById('th-musica').innerText = t.thMusica;
            document.getElementById('th-acao-label').innerText = t.thAcao;
            loadQueue();
        }

        /* --- L√ìGICA DE DJ --- */
        function loginDJ() {
            if(prompt("Senha do DJ:") === "admin123") {
                isDJ = true;
                document.getElementById('dj-panel').style.display = 'flex';
                loadQueue();
            }
        }

        function toggleLock() {
            isLocked = !isLocked;
            localStorage.setItem('karaokeLocked', isLocked);
            document.getElementById('status-bloqueio').style.display = isLocked ? 'block' : 'none';
            document.getElementById('btn-lock-toggle').innerText = isLocked ? "üîì Abrir Entrada" : "üîí Bloquear Pedidos";
        }

        /* --- GEST√ÉO DA FILA --- */
        async function loadQueue() {
            try {
                const resp = await fetch(SHEET_CSV + "&cache=" + Date.now());
                const text = await resp.text();
                const rows = text.split('\n').slice(1);
                
                // Pega os pedidos salvos no celular do usu√°rio
                const myOrders = JSON.parse(localStorage.getItem('myKaraokeOrders') || '[]');
                const myTokens = myOrders.map(o => o.senha);
                let html = '';

                rows.forEach((row, i) => {
                    const cols = row.split(',');
                    // Verifica se a linha tem o c√≥digo da m√∫sica (coluna 5 na planilha)
                    if(cols.length > 5 && cols[5].trim() !== "") {
                        const tokenFila = cols[5].trim();
                        const isMySong = myTokens.includes(tokenFila);
                        
                        // Define destaque e se mostra a senha
                        const rowClass = isMySong ? 'class="row-user"' : "";
                        const showToken = isMySong ? `<br><span class="token-badge">üîë ${translations[currentLang].tokenLabel} ${tokenFila}</span>` : "";

                        // Bot√£o de a√ß√£o (Remover para o usu√°rio ou Deletar para o DJ)
                        let actionBtn = isDJ ? 
                            `<button class="btn-action" style="background:#333; color:white;" onclick="removeSong(${i+1})">üóëÔ∏è</button>` : 
                            (isMySong ? `<button class="btn-action btn-cancel" onclick="removeSong(${i+1}, true)">‚ùå</button>` : '');
                        
                        html += `<tr ${rowClass}>
                                    <td>${i+1}¬∫</td>
                                    <td><strong>${cols[3]}</strong><br><small>${cols[4]}</small>${showToken}</td>
                                    <td>${actionBtn}</td>
                                 </tr>`;
                    }
                });
                document.getElementById('queueBody').innerHTML = html || `<tr><td colspan="3" style="text-align:center; padding: 25px; color:#666;">${translations[currentLang].filaVazia}</td></tr>`;
            } catch(e) {
                console.error("Erro ao carregar fila.");
            }
        }

        function removeSong(rowIndex, isClientAction = false) {
            const msg = isClientAction ? translations[currentLang].cancelPrompt : "DJ: Remover m√∫sica da fila?";
            if(!confirm(msg)) return;
            
            // M√©todo seguro para evitar erro 400 (Bad Request)
            const img = new Image();
            img.src = `${SCRIPT_URL}?row=${rowIndex}&t=${Date.now()}`;
            
            // Feedback visual imediato e recarga
            setTimeout(loadQueue, 1500);
        }

        /* --- SISTEMA DE BUSCA --- */
        function searchSongs() {
            const query = document.getElementById('searchInput').value.toLowerCase().trim();
            const resDiv = document.getElementById('results');
            const alertDiv = document.getElementById('copyright-alert');
            
            if(query.length < 2) { 
                resDiv.innerHTML = ''; 
                alertDiv.style.display = 'none'; 
                return; 
            }
            
            const terms = query.split(' ');
            let matches = catalog.filter(s => {
                if(!s[1]) return false;
                const combined = `${s[1]} ${s[2]}`.toLowerCase();
                return terms.every(t => combined.includes(t));
            });

            if(matches.length > 0) {
                alertDiv.style.display = 'none';
                resDiv.innerHTML = matches.slice(0, 15).map(s => `
                    <div class="song-item" onclick="sendOrderDirect('${s[0]}','${s[1]}','${s[2]}')">
                        <span style="font-size:20px;">üé∂</span>
                        <div><strong>${s[1]}</strong><br><small>${s[2]}</small></div>
                    </div>`).join('');
            } else {
                alertDiv.style.display = 'flex';
                resDiv.innerHTML = '';
            }
        }

        /* --- ENVIO DO PEDIDO --- */
        function sendOrderDirect(id, title, artist) {
            if(isLocked && !isDJ) { 
                alert(translations[currentLang].closed); 
                return; 
            }

            // Gera senha √∫nica e prepara formul√°rio
            const senha = Math.random().toString(36).substring(2, 6).toUpperCase();
            document.getElementById('f_hora').value = new Date().toLocaleTimeString();
            document.getElementById('f_codigo').value = id;
            document.getElementById('f_musica').value = title;
            document.getElementById('f_artista').value = artist;
            document.getElementById('f_senha').value = senha;

            // Envia para o Google Forms via iframe oculto
            document.getElementById('karaokeForm').submit();

            // Salva localmente para o usu√°rio ver sua senha na fila
            let saved = JSON.parse(localStorage.getItem('myKaraokeOrders') || '[]');
            saved.push({ senha, musica: title });
            localStorage.setItem('myKaraokeOrders', JSON.stringify(saved));
            
            // Efeito de sucesso
            confetti({ particleCount: 120, spread: 70, origin: { y: 0.7 } });
            
            // Limpa busca e recarrega fila
            setTimeout(() => { 
                document.getElementById('searchInput').value = ''; 
                document.getElementById('results').innerHTML = ''; 
                loadQueue(); 
            }, 800);
        }
    </script>
</body>
</html>
